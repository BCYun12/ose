<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>OSE - Only Speak English</title>
    <meta name="description" content="Practice English conversation in real-time with language learners worldwide. Join or create rooms instantly!">
    <meta name="keywords" content="English, language exchange, practice, conversation, learning, chat, voice">
    <meta name="author" content="OSE Team">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="OSE">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="firebase-config.js?v=1.4.2"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>OSE</h1>
            <p>Only Speak English - Language Exchange Platform</p>
        </header>

        <!-- Main Menu -->
        <div id="mainMenu" class="screen">
            <div class="menu-buttons">
                <button class="btn primary" onclick="showCreateRoom()">Create Room</button>
                <button class="btn secondary" onclick="showJoinRoom()">Join Room</button>
                <button class="btn secondary" onclick="showRoomList()">Browse Rooms</button>
            </div>
        </div>

        <!-- Room List -->
        <div id="roomList" class="screen hidden">
            <h2>Active Rooms</h2>
            <div class="room-refresh">
                <button class="btn secondary" onclick="refreshRoomList()">🔄 Refresh</button>
                <button class="btn secondary" onclick="testFirebase()">🔥 Test Firebase</button>
                <span id="roomCount">Loading...</span>
            </div>
            
            <div id="activeRooms" class="rooms-container">
                <!-- Rooms will be populated here -->
            </div>
            
            <div class="button-group">
                <button class="btn secondary" onclick="showMainMenu()">Back</button>
            </div>
            
            <!-- Manual Join Section -->
            <div class="manual-join">
                <h3>Can't find the room? Join manually:</h3>
                <div class="form-group">
                    <input type="text" id="manualRoomId" placeholder="Enter Room ID">
                    <button class="btn primary" onclick="joinManualRoom()">Join</button>
                </div>
            </div>
        </div>

        <!-- Create Room -->
        <div id="createRoom" class="screen hidden">
            <h2>Create a New Room</h2>
            <form id="createRoomForm">
                <div class="form-group">
                    <label>Your Name:</label>
                    <input type="text" id="hostName" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group">
                    <label>Room Title:</label>
                    <input type="text" id="roomTitle" placeholder="e.g., English Practice for Beginners" required>
                </div>
                
                <div class="form-group">
                    <label>Language:</label>
                    <select id="roomLanguage" required>
                        <option value="">Select Language</option>
                        <option value="english">English</option>
                        <option value="korean">Korean</option>
                        <option value="japanese">Japanese</option>
                        <option value="mixed">Mixed Languages</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Level:</label>
                    <select id="roomLevel" required>
                        <option value="">Select Level</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                        <option value="mixed">Mixed Levels</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Max Participants:</label>
                    <select id="maxParticipants">
                        <option value="2">2 people</option>
                        <option value="4" selected>4 people</option>
                        <option value="6">6 people</option>
                        <option value="8">8 people</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn secondary" onclick="showMainMenu()">Back</button>
                    <button type="submit" class="btn primary">Create Room</button>
                </div>
            </form>
        </div>

        <!-- Join Room -->
        <div id="joinRoom" class="screen hidden">
            <h2>Join a Room</h2>
            <form id="joinRoomForm">
                <div class="form-group">
                    <label>Your Name:</label>
                    <input type="text" id="guestName" placeholder="Enter your name" required>
                </div>
                
                <div class="form-group">
                    <label>Room ID:</label>
                    <input type="text" id="roomId" placeholder="Enter room ID" required>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn secondary" onclick="showMainMenu()">Back</button>
                    <button type="submit" class="btn primary">Join Room</button>
                </div>
            </form>
        </div>

        <!-- Chat Room -->
        <div id="chatRoom" class="screen hidden">
            <div class="chat-header">
                <div class="room-info">
                    <h3 id="currentRoomTitle">Room Name</h3>
                    <span id="currentRoomDetails">English • Intermediate • Room ID: <span id="displayRoomId"></span></span>
                </div>
                <button class="btn danger" onclick="leaveRoom()">Leave Room</button>
            </div>
            
            <div class="participants">
                <h4>Participants (<span id="participantCount">0</span>)</h4>
                <div id="participantList"></div>
                
                <!-- AI Invite Section -->
                <div class="ai-invite-section">
                    <div id="aiInviteButton" class="ai-invite-wrapper">
                        <button class="btn ai-invite" onclick="showAIInvite()">
                            🤖 Invite AI Partner
                        </button>
                    </div>
                    
                    <div id="aiQuickSetup" class="ai-quick-setup hidden">
                        <h5>Quick AI Setup</h5>
                        <select id="quickAIProvider">
                            <option value="">Select AI Service</option>
                            <option value="chatgpt">🧠 ChatGPT Plus</option>
                            <option value="gemini">💎 Gemini Advanced</option>
                            <option value="claude">🎭 Claude Pro</option>
                        </select>
                        <input type="email" id="quickAIEmail" placeholder="Your email" style="margin-top: 8px;">
                        <input type="password" id="quickAIPassword" placeholder="Your password" style="margin-top: 5px;">
                        <div class="quick-ai-buttons">
                            <button class="btn secondary small" onclick="cancelAIInvite()">Cancel</button>
                            <button class="btn primary small" onclick="inviteAI()">Invite AI</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <div id="chatMessages" class="chat-messages"></div>
                
                <div class="chat-input">
                    <div class="voice-controls">
                        <button id="micBtn" class="btn voice-btn" onclick="toggleMic()">
                            <span id="micIcon">🎤</span>
                        </button>
                        <button id="speakerBtn" class="btn voice-btn" onclick="toggleSpeaker()">
                            <span id="speakerIcon">🔊</span>
                        </button>
                    </div>
                    
                    <div class="text-input">
                        <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                        <button class="btn primary" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Loading Screen -->
        <div id="loadingScreen" class="screen hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p id="loadingMessage">Connecting to room...</p>
                <div class="loading-steps">
                    <div id="loadingStep">Initializing connection...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inline essential functions to work immediately
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
            }
        }
        
        function showMainMenu() {
            showScreen('mainMenu');
        }
        
        function showCreateRoom() {
            showScreen('createRoom');
        }
        
        function showJoinRoom() {
            showScreen('joinRoom');
        }
        
        function showRoomList() {
            showScreen('roomList');
            // 즉시 방 목록 표시
            refreshRoomList();
        }
        
        function showAIInvite() {
            const button = document.getElementById('aiInviteButton');
            const setup = document.getElementById('aiQuickSetup');
            if (button) button.classList.add('hidden');
            if (setup) setup.classList.remove('hidden');
        }
        
        function cancelAIInvite() {
            const button = document.getElementById('aiInviteButton');
            const setup = document.getElementById('aiQuickSetup');
            if (button) button.classList.remove('hidden');
            if (setup) setup.classList.add('hidden');
        }
        
        function inviteAI() {
            const provider = document.getElementById('quickAIProvider').value;
            const email = document.getElementById('quickAIEmail').value.trim();
            const password = document.getElementById('quickAIPassword').value.trim();
            
            if (!provider) {
                alert('Please select an AI service');
                return;
            }
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Show loading
            const inviteBtn = document.querySelector('#aiQuickSetup .btn.primary');
            const originalText = inviteBtn.textContent;
            inviteBtn.textContent = 'Inviting AI...';
            inviteBtn.disabled = true;
            
            // Simulate AI connection
            setTimeout(() => {
                // Create AI participant
                const aiNames = {
                    'chatgpt': '🧠 ChatGPT',
                    'gemini': '💎 Gemini', 
                    'claude': '🎭 Claude'
                };
                
                const aiId = 'ai-' + provider;
                const aiName = aiNames[provider];
                
                // Add AI to participant list
                const participantList = document.getElementById('participantList');
                const participantCount = document.getElementById('participantCount');
                
                const aiParticipant = document.createElement('div');
                aiParticipant.className = 'participant ai-participant';
                aiParticipant.innerHTML = `<span class="participant-name">${aiName}</span><span class="participant-status">AI Assistant</span>`;
                participantList.appendChild(aiParticipant);
                
                // Update participant count
                const currentCount = parseInt(participantCount.textContent) || 0;
                participantCount.textContent = (currentCount + 1).toString();
                
                // Add welcome message from AI
                const welcomeMessages = {
                    'chatgpt': "Hello! I'm ChatGPT, your AI language partner. I'm here to help you practice English. What would you like to talk about?",
                    'gemini': "Hi there! I'm Gemini, ready to help you improve your English skills. Let's have a great conversation!",
                    'claude': "Greetings! I'm Claude, your AI conversation partner. I'm excited to help you practice English today!"
                };
                
                const messagesContainer = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = 'message ai-message other';
                
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="sender">${aiName}</div>
                    <div class="text">${welcomeMessages[provider]}</div>
                    <div class="time">${timeString}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Hide setup form
                cancelAIInvite();
                
                // Reset button
                inviteBtn.textContent = originalText;
                inviteBtn.disabled = false;
                
                console.log('✅ AI successfully invited:', aiName);
                
            }, 2000);
        }
        
        // Complete form handling functions
        function handleCreateRoom() {
            const hostName = document.getElementById('hostName').value.trim();
            const roomTitle = document.getElementById('roomTitle').value.trim();
            const roomLanguage = document.getElementById('roomLanguage').value;
            const roomLevel = document.getElementById('roomLevel').value;
            const maxParticipants = document.getElementById('maxParticipants').value;
            
            if (!hostName || !roomTitle || !roomLanguage || !roomLevel) {
                alert('Please fill in all required fields');
                return false;
            }
            
            // Generate room ID
            const roomId = 'room_' + Math.random().toString(36).substring(2, 8);
            
            // Show loading
            showScreen('loadingScreen');
            document.getElementById('loadingMessage').textContent = 'Creating room...';
            document.getElementById('loadingStep').textContent = 'Setting up your room...';
            
            // Simulate room creation (will be replaced by full app.js when loaded)
            setTimeout(() => {
                // Store room data
                const roomData = {
                    id: roomId,
                    title: roomTitle,
                    language: roomLanguage,
                    level: roomLevel,
                    maxParticipants: parseInt(maxParticipants),
                    hostName: hostName,
                    participants: new Map(),
                    created: new Date().toISOString()
                };
                
                // Set current room info
                document.getElementById('currentRoomTitle').textContent = roomTitle;
                document.getElementById('currentRoomDetails').innerHTML = 
                    `${roomLanguage.charAt(0).toUpperCase() + roomLanguage.slice(1)} • ${roomLevel.charAt(0).toUpperCase() + roomLevel.slice(1)} • Room ID: <span id="displayRoomId">${roomId}</span>`;
                document.getElementById('displayRoomId').textContent = roomId;
                
                // Show host in participants
                document.getElementById('participantList').innerHTML = 
                    `<div class="participant host"><span class="participant-name">${hostName}</span><span class="participant-status">Host</span></div>`;
                document.getElementById('participantCount').textContent = '1';
                
                // Go to chat room
                showScreen('chatRoom');
                
                // If full app is loaded, initialize properly
                if (window.app) {
                    app.currentRoom = roomId;
                    app.userName = hostName;
                    app.isHost = true;
                    app.roomData = roomData;
                }
            }, 1500);
            
            return false; // Prevent form submission
        }
        
        function handleJoinRoom() {
            const guestName = document.getElementById('guestName').value.trim();
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!guestName || !roomId) {
                alert('Please enter your name and room ID');
                return false;
            }
            
            // Show loading
            showScreen('loadingScreen');
            document.getElementById('loadingMessage').textContent = 'Joining room...';
            document.getElementById('loadingStep').textContent = 'Connecting to room...';
            
            // Simulate room join
            setTimeout(() => {
                // Set room info (mock data for now)
                document.getElementById('currentRoomTitle').textContent = 'Practice Room';
                document.getElementById('currentRoomDetails').innerHTML = 
                    `English • Intermediate • Room ID: <span id="displayRoomId">${roomId}</span>`;
                
                // Show guest in participants  
                document.getElementById('participantList').innerHTML = 
                    `<div class="participant"><span class="participant-name">${guestName}</span><span class="participant-status">Guest</span></div>`;
                document.getElementById('participantCount').textContent = '1';
                
                // Go to chat room
                showScreen('chatRoom');
                
                // If full app is loaded, initialize properly
                if (window.app) {
                    app.currentRoom = roomId;
                    app.userName = guestName;
                    app.isHost = false;
                }
            }, 1500);
            
            return false; // Prevent form submission
        }
        
        function handleManualJoin() {
            const roomId = document.getElementById('manualRoomId').value.trim();
            if (!roomId) {
                alert('Please enter a Room ID');
                return;
            }
            
            // Set room ID and show join form
            document.getElementById('roomId').value = roomId;
            showScreen('joinRoom');
        }
        
        function leaveRoom() {
            if (confirm('Are you sure you want to leave the room?')) {
                showScreen('mainMenu');
                
                // Clear room data
                if (window.app) {
                    app.currentRoom = null;
                    app.userName = '';
                    app.isHost = false;
                    app.roomData = {};
                }
            }
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message own';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="sender">You</div>
                <div class="text">${message}</div>
                <div class="time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            messageInput.value = '';
            
            // If full app is loaded, use its functionality
            if (window.app && app.sendMessage) {
                app.sendMessage();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function refreshRoomList() {
            // Mock room data for immediate functionality
            const mockRooms = [
                {
                    id: 'room_demo1',
                    title: 'English Practice for Beginners',
                    language: 'English',
                    level: 'Beginner',
                    participants: 2,
                    maxParticipants: 4,
                    status: 'online',
                    created: new Date(Date.now() - 300000).toISOString()
                },
                {
                    id: 'room_demo2', 
                    title: 'Korean Language Exchange',
                    language: 'Korean',
                    level: 'Intermediate',
                    participants: 1,
                    maxParticipants: 6,
                    status: 'online',
                    created: new Date(Date.now() - 600000).toISOString()
                },
                {
                    id: 'room_demo3',
                    title: 'Advanced English Conversation',
                    language: 'English', 
                    level: 'Advanced',
                    participants: 3,
                    maxParticipants: 8,
                    status: 'online',
                    created: new Date(Date.now() - 900000).toISOString()
                }
            ];
            
            const roomsContainer = document.getElementById('activeRooms');
            const roomCount = document.getElementById('roomCount');
            
            if (mockRooms.length === 0) {
                roomsContainer.innerHTML = '<div class="empty-rooms">No active rooms found. Create one to get started!</div>';
                roomCount.textContent = 'No rooms';
            } else {
                roomCount.textContent = `${mockRooms.length} active room${mockRooms.length > 1 ? 's' : ''}`;
                
                roomsContainer.innerHTML = mockRooms.map(room => `
                    <div class="room-card" onclick="joinSpecificRoom('${room.id}', '${room.title}')">
                        <div class="room-header">
                            <h4 class="room-title">${room.title}</h4>
                            <span class="room-status ${room.status}">${room.status}</span>
                        </div>
                        <div class="room-details">
                            ${room.language} • ${room.level} • ${room.participants}/${room.maxParticipants} participants
                        </div>
                        <div class="room-meta">
                            <span class="room-participants">${room.participants} online</span>
                            <span class="room-code">${room.id}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            // If full app is loaded, use its functionality
            if (window.app && app.loadRoomList) {
                app.loadRoomList();
            }
        }
        
        function joinSpecificRoom(roomId, roomTitle) {
            // Set room ID and title, then show join form
            document.getElementById('roomId').value = roomId;
            showScreen('joinRoom');
            
            // Pre-fill some info if available
            const joinTitle = document.querySelector('#joinRoom h2');
            if (joinTitle) {
                joinTitle.textContent = `Join "${roomTitle}"`;
            }
        }
        
        function testFirebase() {
            alert('Firebase connection test - this feature will be available when the full app loads.');
        }
        
        // Add event listeners as backup for onclick issues
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to main menu buttons
            const createBtn = document.querySelector('button[onclick="showCreateRoom()"]');
            const joinBtn = document.querySelector('button[onclick="showJoinRoom()"]');
            const browseBtn = document.querySelector('button[onclick="showRoomList()"]');
            
            if (createBtn) {
                createBtn.addEventListener('click', function(e) {
                    if (!window.createRoomHandled) {
                        e.preventDefault();
                        showScreen('createRoom');
                        window.createRoomHandled = true;
                        setTimeout(() => window.createRoomHandled = false, 100);
                    }
                });
            }
            
            if (joinBtn) {
                joinBtn.addEventListener('click', function(e) {
                    if (!window.joinRoomHandled) {
                        e.preventDefault();
                        showScreen('joinRoom');
                        window.joinRoomHandled = true;
                        setTimeout(() => window.joinRoomHandled = false, 100);
                    }
                });
            }
            
            if (browseBtn) {
                browseBtn.addEventListener('click', function(e) {
                    if (!window.browseRoomHandled) {
                        e.preventDefault();
                        showScreen('roomList');
                        // 즉시 방 목록 표시
                        setTimeout(() => refreshRoomList(), 100);
                        window.browseRoomHandled = true;
                        setTimeout(() => window.browseRoomHandled = false, 100);
                    }
                });
            }
            
            // Add form event listeners
            const createRoomForm = document.getElementById('createRoomForm');
            if (createRoomForm) {
                createRoomForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleCreateRoom();
                });
            }
            
            const joinRoomForm = document.getElementById('joinRoomForm');
            if (joinRoomForm) {
                joinRoomForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleJoinRoom();
                });
            }
            
            // Manual join button
            const manualJoinBtn = document.querySelector('button[onclick="joinManualRoom()"]');
            if (manualJoinBtn) {
                manualJoinBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleManualJoin();
                });
            }
            
            // Send message button
            const sendBtn = document.querySelector('button[onclick="sendMessage()"]');
            if (sendBtn) {
                sendBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    sendMessage();
                });
            }
            
            // Leave room button
            const leaveBtn = document.querySelector('button[onclick="leaveRoom()"]');
            if (leaveBtn) {
                leaveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    leaveRoom();
                });
            }
            
            // Refresh button
            const refreshBtn = document.querySelector('button[onclick="refreshRoomList()"]');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    refreshRoomList();
                });
            }
            
            // Test Firebase button  
            const firebaseBtn = document.querySelector('button[onclick="testFirebase()"]');
            if (firebaseBtn) {
                firebaseBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    testFirebase();
                });
            }
            
            // Load the full app.js
            const script = document.createElement('script');
            script.src = 'app.js?t=' + Date.now();
            script.onload = function() {
                console.log('✅ App.js loaded successfully');
            };
            script.onerror = function() {
                console.error('❌ Failed to load app.js');
                alert('Failed to load application. Please refresh the page.');
            };
            document.head.appendChild(script);
        });
    </script>
</body>
</html>